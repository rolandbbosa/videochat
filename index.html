<html>
  <head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <style>
        video {
  background-color: #ddd;
  border-radius: 7px;
  margin: 10px;
  width: 320px;
  height: 240px;
}
#chat {
  position: fixed;
  bottom: 0;
  right: 0;
  width: 300px;
  height: 200px;
  background: white;
  border: 1px solid #ccc;
  display: none;
}
#chatMessages {
  height: 150px;
  overflow-y: auto;
}
button {
  margin: 5px;
}
#waiting {
  text-align: center;
  font-size: 24px;
  margin-top: 50px;
}
    </style>
  </head>
  <body>
    <div id="waiting" style="display:none;">Waiting for a partner...</div>
    <div id="connected">
      <video id="yourVideo" autoplay muted playsinline></video>
      <video id="friendsVideo" autoplay playsinline></video>
      <br />
      <button id="endBtn" onclick="endCall()" type="button" class="btn btn-danger">End Call</button>
      <button id="nextBtn" onclick="nextPartner()" type="button" class="btn btn-warning">Next</button>
      <button id="disconnectBtn" onclick="disconnect()" type="button" class="btn btn-secondary">Disconnect</button>
      <button id="chatBtn" onclick="toggleChat()" type="button" class="btn btn-info">Toggle Chat</button>
      <button id="reportBtn" onclick="reportUser()" type="button" class="btn btn-danger">Report</button>
    </div>
    <div id="chat">
      <div id="chatMessages"></div>
      <input id="chatInput" type="text" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
      <button onclick="sendChatMessage()">Send</button>
    </div>
    <div id="startDiv">
      <button id="startBtn" onclick="start()" type="button" class="btn btn-success btn-lg">Start Chatting</button>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Firebase config
var config = {
  apiKey: "AIzaSyBrIcWjuJ62Ni1M3ds963R6sj-PAU59wvQ",
  authDomain: "videochat-d857b.firebaseapp.com",
  databaseURL: "https://videochat-d857b-default-rtdb.firebaseio.com",
  projectId: "videochat-d857b",
  storageBucket: "videochat-d857b.firebasestorage.app",
  messagingSenderId: "602319735026"
};
firebase.initializeApp(config);

var database = firebase.database();
var yourId = Math.floor(Math.random()*1000000000);
var currentRoom = null;
var pc = null;
var localStream = null;
var waitingRef = database.ref('waiting');
var roomsRef = database.ref('rooms');
var reportsRef = database.ref('reports');

document.getElementById('connected').style.display = 'none';
document.getElementById('waiting').style.display = 'none';

function start() {
  document.getElementById('startDiv').style.display = 'none';
  document.getElementById('waiting').style.display = 'block';
  navigator.mediaDevices.getUserMedia({audio:true, video:true})
    .then(stream => {
      localStream = stream;
      document.getElementById("yourVideo").srcObject = stream;
      joinWaiting();
    })
    .catch(err => console.error('Error accessing media devices.', err));
}

function joinWaiting() {
  waitingRef.push(yourId);
  waitingRef.on('value', (snapshot) => {
    var waitingUsers = [];
    snapshot.forEach(child => {
      waitingUsers.push({id: child.val(), key: child.key});
    });
    if (waitingUsers.length >= 2) {
      // Pair the first two
      var user1 = waitingUsers[0];
      var user2 = waitingUsers[1];
      if (user1.id == yourId || user2.id == yourId) {
        // Remove from waiting
        waitingRef.child(user1.key).remove();
        waitingRef.child(user2.key).remove();
        // Create room
        var roomId = user1.id + '_' + user2.id;
        currentRoom = roomId;
        setupRoom(roomId);
      }
    }
  });
}

function setupRoom(roomId) {
  document.getElementById('waiting').style.display = 'none';
  document.getElementById('connected').style.display = 'block';
  pc = new RTCPeerConnection({'iceServers': [{'urls': 'stun:stun.services.mozilla.com'}, {'urls': 'stun:stun.l.google.com:19302'}, {'urls': 'turn:numb.viagenie.ca','credential': 'beaver','username': 'webrtc.websitebeaver@gmail.com'}]});
  pc.onicecandidate = (event) => {
    if (event.candidate) {
      sendMessage(roomId, JSON.stringify({'ice': event.candidate}));
    }
  };
  pc.ontrack = (event) => {
    document.getElementById("friendsVideo").srcObject = event.streams[0];
  };
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  var roomRef = roomsRef.child(roomId);
  roomRef.on('child_added', readMessage);
  // Start call
  pc.createOffer()
    .then(offer => pc.setLocalDescription(offer))
    .then(() => sendMessage(roomId, JSON.stringify({'sdp': pc.localDescription})));
}

function sendMessage(roomId, data) {
  roomsRef.child(roomId).push({ sender: yourId, message: data });
}

function readMessage(data) {
  var msg = JSON.parse(data.val().message);
  var sender = data.val().sender;
  if (sender != yourId) {
    if (msg.ice) {
      pc.addIceCandidate(new RTCIceCandidate(msg.ice));
    } else if (msg.sdp && msg.sdp.type == "offer") {
      pc.setRemoteDescription(new RTCSessionDescription(msg.sdp))
        .then(() => pc.createAnswer())
        .then(answer => pc.setLocalDescription(answer))
        .then(() => sendMessage(currentRoom, JSON.stringify({'sdp': pc.localDescription})));
    } else if (msg.sdp && msg.sdp.type == "answer") {
      pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
    } else if (msg.chat) {
      displayChatMessage(msg.chat);
    }
  }
}

function endCall() {
  if (pc) {
    pc.close();
    pc = null;
  }
  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
  }
  document.getElementById("friendsVideo").srcObject = null;
  document.getElementById('connected').style.display = 'none';
  document.getElementById('startDiv').style.display = 'block';
  if (currentRoom) {
    roomsRef.child(currentRoom).off();
    currentRoom = null;
  }
}

function nextPartner() {
  endCall();
  start();
}

function disconnect() {
  endCall();
}

function toggleChat() {
  var chat = document.getElementById('chat');
  chat.style.display = chat.style.display === 'none' ? 'block' : 'none';
}

function sendChatMessage() {
  var input = document.getElementById('chatInput');
  var message = input.value.trim();
  if (message && currentRoom) {
    sendMessage(currentRoom, JSON.stringify({'chat': message}));
    displayChatMessage('You: ' + message);
    input.value = '';
  }
}

function handleKeyPress(event) {
  if (event.key === 'Enter') {
    sendChatMessage();
  }
}

function displayChatMessage(message) {
  var messages = document.getElementById('chatMessages');
  messages.innerHTML += '<div>' + message + '</div>';
  messages.scrollTop = messages.scrollHeight;
}

function reportUser() {
  if (currentRoom) {
    reportsRef.push({ reporter: yourId, room: currentRoom, timestamp: Date.now() });
    alert('User reported. Moderators will review.');
  }
}
    </script>
  </body>
</html>
