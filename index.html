<html>
  <head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <style>
        video {
  background-color: #ddd;
  border-radius: 7px;
  margin: 10px 0px 0px 10px;
  width: 320px;
  height: 240px;
}
button {
  margin: 5px 5px 0px 10px !important;
  width: 150px;
}
    </style>
  </head>
  <body>
    <video id="yourVideo" autoplay muted playsinline></video>
    <video id="friendsVideo" autoplay playsinline></video>
    <br />
    <button id="startBtn" onclick="start()" type="button" class="btn btn-success btn-lg">Start</button>
    <button id="nextBtn" onclick="next()" type="button" class="btn btn-primary btn-lg" disabled>Next</button>
    <button id="endBtn" onclick="end()" type="button" class="btn btn-warning btn-lg" disabled>End</button>
    <button id="disconnectBtn" onclick="disconnect()" type="button" class="btn btn-danger btn-lg">Disconnect</button>
    <script src="https://www.gstatic.com/firebasejs/4.9.0/firebase.js"></script>
    <script>
        //Create an account on Firebase, and use the credentials they give you in place of the following
var config = {
  apiKey: "AIzaSyBrIcWjuJ62Ni1M3ds963R6sj-PAU59wvQ",
  authDomain: "videochat-d857b.firebaseapp.com",
  databaseURL: "https://videochat-d857b-default-rtdb.firebaseio.com",
  projectId: "videochat-d857b",
  storageBucket: "videochat-d857b.firebasestorage.app",
  messagingSenderId: "602319735026"
};
firebase.initializeApp(config);

var queueRef = firebase.database().ref('queue');
var signalsRef = firebase.database().ref('signals');
var pairRef = firebase.database().ref('pairs');
var yourVideo = document.getElementById("yourVideo");
var friendsVideo = document.getElementById("friendsVideo");
var startBtn = document.getElementById("startBtn");
var nextBtn = document.getElementById("nextBtn");
var endBtn = document.getElementById("endBtn");
var disconnectBtn = document.getElementById("disconnectBtn");
var yourId = Math.floor(Math.random()*1000000000);
var currentPairId = null;
var pc = null;
var localStream = null;
var isConnected = false;
var isWaiting = false;
//Create an account on Viagenie (http://numb.viagenie.ca/), and replace {'urls': 'turn:numb.viagenie.ca','credential': 'websitebeaver','username': 'websitebeaver@email.com'} with the information from your account
var servers = {'iceServers': [{'urls': 'stun:stun.services.mozilla.com'}, {'urls': 'stun:stun.l.google.com:19302'}, {'urls': 'turn:numb.viagenie.ca','credential': 'beaver','username': 'webrtc.websitebeaver@gmail.com'}]};

function updateButtons() {
  startBtn.disabled = isWaiting || isConnected;
  nextBtn.disabled = !isConnected;
  endBtn.disabled = !isConnected;
  disconnectBtn.disabled = false;
}

function start() {
  if (isWaiting || isConnected) return;
  navigator.mediaDevices.getUserMedia({audio:true, video:true})
    .then(stream => {
      localStream = stream;
      yourVideo.srcObject = stream;
      pc = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.onicecandidate = (event => event.candidate ? sendMessage(JSON.stringify({'ice': event.candidate})) : console.log("Sent All Ice"));
      pc.ontrack = (event) => {
        friendsVideo.srcObject = event.streams[0];
        isConnected = true;
        updateButtons();
      };
      isWaiting = true;
      updateButtons();
      // Add to queue
      var queueItem = queueRef.push();
      queueItem.set(yourId);
      // Listen for pairing
      queueRef.on('value', handleQueue);
    })
    .catch(error => console.error('Error accessing media devices.', error));
}

function handleQueue(snapshot) {
  var queue = snapshot.val();
  if (!queue || !isWaiting) return;
  var keys = Object.keys(queue);
  if (keys.length >= 2) {
    var key1 = keys[0];
    var key2 = keys[1];
    var id1 = queue[key1];
    var id2 = queue[key2];
    if (id1 == yourId || id2 == yourId) {
      currentPairId = id1 < id2 ? id1 + '_' + id2 : id2 + '_' + id1;
      pairRef.child(currentPairId).set({user1: id1, user2: id2});
      queueRef.child(key1).remove();
      queueRef.child(key2).remove();
      // Start signaling
      startSignaling();
    }
  }
}

function startSignaling() {
  signalsRef.child(currentPairId).on('child_added', readMessage);
  // Determine who initiates
  var ids = currentPairId.split('_');
  if (yourId == ids[0]) {
    pc.createOffer()
      .then(offer => pc.setLocalDescription(offer))
      .then(() => sendMessage(JSON.stringify({'sdp': pc.localDescription})));
  }
}

function sendMessage(data) {
  if (currentPairId) {
    signalsRef.child(currentPairId).push({sender: yourId, message: data});
  }
}

function readMessage(data) {
  var msg = JSON.parse(data.val().message);
  var sender = data.val().sender;
  if (sender != yourId) {
    if (msg.ice != undefined)
      pc.addIceCandidate(new RTCIceCandidate(msg.ice));
    else if (msg.sdp.type == "offer")
      pc.setRemoteDescription(new RTCSessionDescription(msg.sdp))
        .then(() => pc.createAnswer())
        .then(answer => pc.setLocalDescription(answer))
        .then(() => sendMessage(JSON.stringify({'sdp': pc.localDescription})));
    else if (msg.sdp.type == "answer")
      pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
  }
}

function next() {
  if (!isConnected) return;
  // Close current connection
  var oldPairId = currentPairId;
  pc.close();
  pc = null;
  friendsVideo.srcObject = null;
  isConnected = false;
  currentPairId = null;
  if (oldPairId) signalsRef.child(oldPairId).off('child_added', readMessage);
  // Re-enter queue
  start();
}

function end() {
  if (!isConnected) return;
  var oldPairId = currentPairId;
  pc.close();
  pc = null;
  friendsVideo.srcObject = null;
  isConnected = false;
  currentPairId = null;
  if (oldPairId) signalsRef.child(oldPairId).off('child_added', readMessage);
  isWaiting = false;
  updateButtons();
}

function disconnect() {
  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
    localStream = null;
    yourVideo.srcObject = null;
  }
  if (pc) {
    pc.close();
    pc = null;
    friendsVideo.srcObject = null;
  }
  isConnected = false;
  isWaiting = false;
  var oldPairId = currentPairId;
  currentPairId = null;
  if (oldPairId) signalsRef.child(oldPairId).off('child_added', readMessage);
  // Remove from queue
  queueRef.once('value', (snapshot) => {
    snapshot.forEach(child => {
      if (child.val() == yourId) child.ref.remove();
    });
  });
  updateButtons();
}
    </script>
  </body>
</html>
